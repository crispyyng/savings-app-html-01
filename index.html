<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å„²è“„åŠ©æ‰‹ (å–®ä¸€æª”æ¡ˆå®Œæ•´ç‰ˆ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    /* éš±è—æ²è»¸ä½†ä¿æŒå¯æ»¾å‹• */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* ç¢ºä¿åœ¨ iOS ä¸Šè¼¸å…¥æ™‚ä¸æœƒè‡ªå‹•æ”¾å¤§ */
    input, select, textarea { font-size: 16px !important; }
  </style>
</head>
<body class="bg-neutral-50 text-neutral-800 font-sans antialiased">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
      GoogleAuthProvider, signInWithPopup, signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const { useState, useEffect, useMemo, useRef } = React;

    // ==========================================
    // 1. Firebase & æ ¸å¿ƒè¨­å®š
    // ==========================================
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyD5iLIBqMK__fqyRUObXnO9S55Rne0gQnY",
      authDomain: "my-savings-app-138fd.firebaseapp.com",
      projectId: "my-savings-app-138fd",
      storageBucket: "my-savings-app-138fd.firebasestorage.app",
      messagingSenderId: "610693434561",
      appId: "1:610693434561:web:00221b38ee48d3cb875840",
      measurementId: "G-4FV1FGDX28"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-local-savings-app';
    const apiKey = ""; // Gemini API Key (ç”±ç³»çµ±ç’°å¢ƒæä¾›)

    // ==========================================
    // 2. éœæ…‹è³‡æºèˆ‡å­—å…¸
    // ==========================================
    const CATEGORIES = {
      zh: ["åŸºæœ¬ç”Ÿæ´»", "ç¤¾äº¤/å¨›æ¨‚", "çªç™¼/ç·Šæ€¥", "å›ºå®šæ”¯å‡º", "å…¶ä»–"],
      en: ["Living", "Social/Fun", "Emergency", "Fixed", "Other"]
    };

    const dict = {
      zh: {
        appTitle: "å„²è“„åŠ©æ‰‹", analysisTitle: "æ•¸æ“šåˆ†æ", dailyBudget: "æ¯æ—¥é ç®—", todayRemaining: "ä»Šæ—¥å‰©é¤˜é ç®—",
        cumulativeSurplus: "ç´¯ç©å¯ç”¨ç›ˆé¤˜", aiEntryTitle: "ğŸ¤– AI æ™ºèƒ½è¨˜å¸³", aiPlaceholder: "ä¾‹ï¼šåˆé¤æ»·è‚‰é£¯ 120å…ƒ",
        aiBtn: "è§£æ", manualEntryTitle: "ğŸ’¸ æ‰‹å‹•è¨˜å¸³", itemName: "é …ç›®åç¨±", amount: "é‡‘é¡", category: "åˆ†é¡",
        note: "å‚™è¨»", saveBtn: "å„²å­˜ç´€éŒ„", todayDetails: "ä»Šæ—¥æ˜ç´°", wishTitle: "å¿ƒé¡˜æ¸…å–®", wishDesc: "æƒ³è²·ä»€éº¼ï¼Ÿ",
        wishDescriptionPlaceholder: "è£œå……æè¿° (ä¾‹å¦‚: å‹è™Ÿã€é¡è‰²ã€è³¼è²·åŸå› )",
        wishPrice: "é ä¼°é‡‘é¡", wishMeaning: "é€™å€‹å¿ƒé¡˜å°ä½ çš„æ„ç¾©ï¼Ÿ", wishBtn: "åŠ å…¥å¿ƒé¡˜æ¸…å–®",
        wishEmpty: "ç›®å‰æ²’æœ‰ç¬¦åˆçš„å¿ƒé¡˜ï¼Œç¹¼çºŒä¿æŒï¼", wishShowTier: "é¡¯ç¤ºå±¤ç´šï¼š", addSubItem: "æ–°å¢å­ä»»å‹™ (æŒ‰ Enter)",
        today: "ä»Šæ—¥", thisWeek: "æœ¬é€±", thisMonth: "æœ¬æœˆ", customRange: "è‡ªè¨‚", to: "è‡³",
        totalSpentRange: "å€é–“ç¸½èŠ±è²»", chartCategory: "åˆ†é¡æ”¯å‡ºä½”æ¯”", chartTrend: "æ¯æ—¥èŠ±è²»è¶¨å‹¢",
        settings: "è¨­å®š", nickname: "æ‚¨çš„ç¨±å‘¼", baseDate: "è¨ˆç®—èµ·å§‹æ—¥", baseBalance: "åˆå§‹é¤˜é¡ (å¯å¡«è² æ•¸)",
        language: "èªè¨€", loginGoogle: "ä½¿ç”¨ Google ç™»å…¥ä¸¦å‚™ä»½", logout: "ç™»å‡º", anonymous: "è¨ªå®¢ (æœªç™»å…¥)",
        navHome: "æ—¥å¸¸", navWish: "å¿ƒé¡˜", navAnalysis: "åˆ†æ", navSettings: "è¨­å®š",
        exportBtn: "è¤‡è£½ç‚º Markdown ä¾› AI åˆ†æ", exportSuccess: "å·²è¤‡è£½ï¼è«‹å°‡å…§å®¹è²¼çµ¦ AI",
        wishTiers: [
          { level: 1, label: "ğŸŒŸ å¿…å‚™/æŠ•è³‡", desc: "æå‡ç”Ÿæ´»å“è³ªæˆ–å·¥ä½œæ•ˆç‡çš„å¿…éœ€å“" },
          { level: 2, label: "ğŸ˜Š æƒ³è¦/é«”é©—", desc: "å¸¶ä¾†å¿«æ¨‚çš„é«”é©—æˆ–å–œæ­¡çš„ç‰©å“" },
          { level: 3, label: "ğŸ¤” è¡å‹•/è§€æœ›", desc: "çªç„¶æƒ³è²·ä½†å¯ä»¥å†ç­‰ä¸€ä¸‹çš„æ±è¥¿" }
        ], categories: CATEGORIES.zh
      },
      en: {
        appTitle: "Savings App", analysisTitle: "Data Analysis", dailyBudget: "Daily Budget", todayRemaining: "Today's Remaining",
        cumulativeSurplus: "Cumulative Surplus", aiEntryTitle: "ğŸ¤– AI Entry", aiPlaceholder: "e.g., Lunch burger $15",
        aiBtn: "Parse", manualEntryTitle: "ğŸ’¸ Manual Entry", itemName: "Item Name", amount: "Amount", category: "Category",
        note: "Note", saveBtn: "Save Record", todayDetails: "Today's Details", wishTitle: "Wishlist", wishDesc: "What do you want?",
        wishDescriptionPlaceholder: "Description (e.g., model, color)",
        wishPrice: "Est. Price", wishMeaning: "Meaning to you?", wishBtn: "Add to Wishlist",
        wishEmpty: "No wishes matched. Keep it up!", wishShowTier: "Show Tiers:", addSubItem: "Add sub-task (Press Enter)",
        today: "Today", thisWeek: "This Week", thisMonth: "This Month", customRange: "Custom", to: "to",
        totalSpentRange: "Total Spent", chartCategory: "Category Breakdown", chartTrend: "Daily Trend",
        settings: "Settings", nickname: "Nickname", baseDate: "Base Date", baseBalance: "Base Balance",
        language: "Language", loginGoogle: "Login with Google", logout: "Logout", anonymous: "Guest",
        navHome: "Home", navWish: "Wishlist", navAnalysis: "Analysis", navSettings: "Settings",
        exportBtn: "Copy as Markdown for AI", exportSuccess: "Copied! Paste to your AI.",
        wishTiers: [
          { level: 1, label: "ğŸŒŸ Essential", desc: "Improves life or work efficiency" },
          { level: 2, label: "ğŸ˜Š Desire", desc: "Brings joy or favorite items" },
          { level: 3, label: "ğŸ¤” Impulse", desc: "Want it now but can wait" }
        ], categories: CATEGORIES.en
      }
    };

    // ==========================================
    // 3. å…±ç”¨ SVG åœ–ç¤ºçµ„ä»¶
    // ==========================================
    const HomeIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
    const StarIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>;
    const ChartIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>;
    const SettingsIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
    const TrashIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
    const CheckIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
    const PlusIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
    const CopyIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>;

    // ==========================================
    // 4. å–®ä¸€å¿ƒé¡˜å¡ç‰‡çµ„ä»¶ (è™•ç†ç¨ç«‹çš„å­é …ç›®ç‹€æ…‹)
    // ==========================================
    const WishCard = ({ wish, currentTier, onToggle, onDelete, onAddSubItem, onToggleSubItem, onDeleteSubItem, t }) => {
      const [newSubText, setNewSubText] = useState('');

      const handleAdd = (e) => {
        if (e.key === 'Enter' && newSubText.trim()) {
          e.preventDefault();
          onAddSubItem(wish.id, newSubText.trim());
          setNewSubText('');
        }
      };

      const completedSubCount = (wish.subItems || []).filter(s => s.isCompleted).length;
      const totalSubCount = (wish.subItems || []).length;
      const progressPercent = totalSubCount > 0 ? Math.round((completedSubCount / totalSubCount) * 100) : 0;

      return (
        <div className={`bg-white p-4 rounded-3xl flex flex-col gap-3 shadow-sm border transition-all ${wish.isCompleted ? 'border-green-200 bg-green-50/30' : 'border-neutral-100'}`}>
          
          {/* ä¸ŠåŠéƒ¨ï¼šä¸»å¿ƒé¡˜è³‡è¨Š */}
          <div className="flex items-start gap-3">
            <button 
              onClick={() => onToggle(wish.id, wish.isCompleted)}
              className={`mt-1 flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${wish.isCompleted ? 'border-green-500 bg-green-500 text-white' : 'border-neutral-300 text-transparent'}`}
            >
              <CheckIcon />
            </button>
            <div className="flex-1 min-w-0">
              <span className="text-[10px] text-pink-500 font-medium bg-pink-50 px-2 py-0.5 rounded-full">{currentTier.label.split(' ')[0]}</span>
              <p className={`font-bold text-base mt-1.5 ${wish.isCompleted ? 'text-neutral-400 line-through' : 'text-neutral-800'}`}>{wish.title}</p>
              {wish.description && (
                <p className="text-xs text-neutral-500 mt-1 leading-relaxed">{wish.description}</p>
              )}
            </div>
            <div className="text-right flex flex-col items-end">
              <p className={`text-sm ${wish.isCompleted ? 'text-neutral-300' : 'text-neutral-800 font-bold'}`}>${wish.price}</p>
              <button onClick={() => onDelete(wish.id)} className="text-neutral-300 hover:text-red-400 mt-2 p-1">
                <TrashIcon />
              </button>
            </div>
          </div>

          {/* ä¸‹åŠéƒ¨ï¼šå­é …ç›®èˆ‡é€²åº¦åˆ— */}
          <div className="mt-2 pl-9">
            {totalSubCount > 0 && (
              <div className="mb-3">
                <div className="flex justify-between text-[10px] text-neutral-400 mb-1 font-medium">
                  <span>é€²åº¦</span>
                  <span>{completedSubCount} / {totalSubCount}</span>
                </div>
                <div className="w-full bg-neutral-100 rounded-full h-1">
                  <div className="bg-pink-400 h-1 rounded-full transition-all duration-300" style={{ width: `${progressPercent}%` }}></div>
                </div>
              </div>
            )}
            
            <div className="space-y-2 mb-2">
              {(wish.subItems || []).map(sub => (
                <div key={sub.id} className="flex items-center gap-2 group">
                  <button 
                    onClick={() => onToggleSubItem(wish.id, sub.id, sub.isCompleted)}
                    className={`w-4 h-4 rounded border flex items-center justify-center transition-colors ${sub.isCompleted ? 'border-pink-500 bg-pink-500 text-white' : 'border-neutral-300 text-transparent'}`}
                  >
                    <CheckIcon />
                  </button>
                  <span className={`text-xs flex-1 truncate ${sub.isCompleted ? 'text-neutral-400 line-through' : 'text-neutral-600'}`}>
                    {sub.text}
                  </span>
                  <button 
                    onClick={() => onDeleteSubItem(wish.id, sub.id)}
                    className="text-neutral-200 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-0.5"
                  >
                    <TrashIcon />
                  </button>
                </div>
              ))}
            </div>

            <div className="relative">
              <div className="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none text-neutral-400">
                <PlusIcon />
              </div>
              <input 
                type="text" 
                value={newSubText}
                onChange={e => setNewSubText(e.target.value)}
                onKeyDown={handleAdd}
                placeholder={t.addSubItem}
                className="w-full bg-neutral-50 text-xs rounded-xl pl-7 pr-3 py-2 outline-none focus:bg-white focus:ring-1 focus:ring-pink-200 transition-all border border-transparent focus:border-pink-100"
              />
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // 5. æ‡‰ç”¨ç¨‹å¼ä¸»é«”
    // ==========================================
    const App = () => {
      // ç‹€æ…‹ç®¡ç†
      const [isLoading, setIsLoading] = useState(true);
      const [user, setUser] = useState(null);
      const [activeTab, setActiveTab] = useState('home');
      const [expenses, setExpenses] = useState([]);
      const [wishlist, setWishlist] = useState([]);
      const [toastMsg, setToastMsg] = useState('');
      
      const defaultDateStr = new Date().toISOString().split('T')[0];
      const [config, setConfig] = useState({
        language: 'zh', dailyLimit: 300, baseDate: defaultDateStr, baseBalance: 0, nickname: ''
      });
      const t = dict[config.language] || dict.zh;

      // é¡˜æœ›èˆ‡è¨˜å¸³è¡¨å–®ç‹€æ…‹
      const [activeTierFilters, setActiveTierFilters] = useState([1, 2, 3]);
      const [newExpense, setNewExpense] = useState({ item: '', amount: '', category: t.categories[0], note: '', date: defaultDateStr });
      const [newWish, setNewWish] = useState({ title: '', description: '', price: '', level: 2 });
      const [aiText, setAiText] = useState('');
      const [isAiProcessing, setIsAiProcessing] = useState(false);

      // åˆ†æç‹€æ…‹
      const [analysisPreset, setAnalysisPreset] = useState('month');
      const [analysisDateRange, setAnalysisDateRange] = useState({
        start: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0],
        end: defaultDateStr
      });

      // ==========================================
      // åˆå§‹åŒ–èˆ‡èªè­‰
      // ==========================================
      useEffect(() => {
        const initAuth = async () => {
          try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else {
              await signInAnonymously(auth);
            }
          } catch (error) {
            console.error("Auth error:", error);
          }
        };
        initAuth();

        const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
          setUser(currentUser);
          setIsLoading(false);
        });
        return () => unsubscribe();
      }, []);

      useEffect(() => {
        if (!user) return;

        const expensesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'expenses');
        const unsubExpenses = onSnapshot(expensesRef, (snapshot) => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setExpenses(data.sort((a, b) => new Date(b.date) - new Date(a.date)));
        }, (error) => console.error(error));

        const wishlistRef = collection(db, 'artifacts', appId, 'users', user.uid, 'wishlist');
        const unsubWishlist = onSnapshot(wishlistRef, (snapshot) => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setWishlist(data);
        }, (error) => console.error(error));

        const configRef = doc(db, 'artifacts', appId, 'users', user.uid, 'config', 'userConfig');
        const unsubConfig = onSnapshot(configRef, (docSnap) => {
          if (docSnap.exists()) {
            const dbConfig = docSnap.data();
            setConfig(prev => ({ ...prev, ...dbConfig }));
            if (dbConfig.language && dbConfig.language !== config.language) {
               setNewExpense(prev => ({...prev, category: dict[dbConfig.language].categories[0]}));
            }
          }
        }, (error) => console.error(error));

        return () => { unsubExpenses(); unsubWishlist(); unsubConfig(); };
      }, [user]);

      // ==========================================
      // è¼”åŠ©åŠŸèƒ½
      // ==========================================
      const showToast = (msg) => {
        setToastMsg(msg);
        setTimeout(() => setToastMsg(''), 3000);
      };

      // ==========================================
      // æ—¥å¸¸è¨˜å¸³é‚è¼¯
      // ==========================================
      const handleAddExpense = async (e) => {
        e.preventDefault();
        if (!user || !newExpense.amount || !newExpense.item) return;
        try {
          await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'expenses'), {
            item: newExpense.item, amount: Number(newExpense.amount), category: newExpense.category,
            note: newExpense.note, date: newExpense.date, createdAt: new Date().toISOString()
          });
          setNewExpense({ ...newExpense, item: '', amount: '', note: '' });
          showToast("è¨˜å¸³æˆåŠŸï¼");
        } catch (error) { console.error("Error adding expense:", error); }
      };

      const handleDeleteExpense = async (id) => {
        if (!user) return;
        await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'expenses', id));
      };

      const handleAIEntry = async () => {
        if (!aiText.trim() || !user) return;
        setIsAiProcessing(true);
        try {
          const prompt = `Parse this expense input: "${aiText}". Current Date: ${defaultDateStr}. Valid Categories: ${t.categories.join(', ')}. Return ONLY a JSON object with keys: "item" (string), "amount" (number), "category" (string, strictly match one of the valid categories), "date" (YYYY-MM-DD).`;
          
          const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
          const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
          });
          
          if (!res.ok) throw new Error("API request failed");
          const data = await res.json();
          const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
          
          if (resultText) {
            const parsed = JSON.parse(resultText);
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'expenses'), {
              item: parsed.item || "AI è¨˜å¸³", amount: Number(parsed.amount),
              category: t.categories.includes(parsed.category) ? parsed.category : t.categories[0],
              note: "ç”± AI å»ºç«‹", date: parsed.date || defaultDateStr, createdAt: new Date().toISOString()
            });
            setAiText('');
            showToast("AI è§£æä¸¦è¨˜å¸³æˆåŠŸï¼");
          }
        } catch (error) {
          console.error("AI Parse Error:", error);
          showToast("AI è§£æå¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥");
        } finally {
          setIsAiProcessing(false);
        }
      };

      // ==========================================
      // å¿ƒé¡˜æ¸…å–®é‚è¼¯
      // ==========================================
      const handleAddWish = async (e) => {
        e.preventDefault();
        if (!user || !newWish.title || !newWish.price) return;
        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'wishlist'), {
          title: newWish.title, description: newWish.description, price: Number(newWish.price), level: Number(newWish.level), 
          isCompleted: false, subItems: [], createdAt: new Date().toISOString()
        });
        setNewWish({ title: '', description: '', price: '', level: 2 });
        showToast("å·²åŠ å…¥å¿ƒé¡˜æ¸…å–®ï¼");
      };

      const handleToggleWish = async (id, currentStatus) => {
        if (!user) return;
        await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'wishlist', id), { isCompleted: !currentStatus });
      };

      const handleDeleteWish = async (id) => {
        if (!user) return;
        await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'wishlist', id));
      };

      const handleAddSubItem = async (wishId, text) => {
        if (!user) return;
        const wish = wishlist.find(w => w.id === wishId);
        const newSubItems = [...(wish.subItems || []), { id: Date.now().toString(), text, isCompleted: false }];
        await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'wishlist', wishId), { subItems: newSubItems });
      };

      const handleToggleSubItem = async (wishId, subId, currentStatus) => {
        if (!user) return;
        const wish = wishlist.find(w => w.id === wishId);
        const newSubItems = wish.subItems.map(s => s.id === subId ? { ...s, isCompleted: !currentStatus } : s);
        await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'wishlist', wishId), { subItems: newSubItems });
      };

      const handleDeleteSubItem = async (wishId, subId) => {
        if (!user) return;
        const wish = wishlist.find(w => w.id === wishId);
        const newSubItems = wish.subItems.filter(s => s.id !== subId);
        await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'wishlist', wishId), { subItems: newSubItems });
      };

      // ==========================================
      // è¨­å®šèˆ‡åˆ†æé‚è¼¯
      // ==========================================
      const saveConfig = async (newSettings) => {
        if (!user) return;
        const updated = { ...config, ...newSettings };
        setConfig(updated);
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'config', 'userConfig'), updated);
        } catch (error) {
          await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'config'), updated);
        }
      };

      const handleGoogleLogin = async () => {
        try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (error) { console.error(error); }
      };
      const handleLogout = async () => {
        try { await signOut(auth); } catch (error) { console.error(error); }
      };

      // æ•¸æ“šè¨ˆç®—
      const baseDateObj = new Date(config.baseDate || defaultDateStr);
      const todayObj = new Date(defaultDateStr);
      const diffTime = Math.max(0, todayObj - baseDateObj);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      const totalBudgetSinceBase = diffDays * config.dailyLimit;
      const expensesSinceBase = expenses.filter(e => e.date >= config.baseDate);
      const totalSpentSinceBase = expensesSinceBase.reduce((sum, e) => sum + e.amount, 0);
      const cumulativeSurplus = (config.baseBalance || 0) + totalBudgetSinceBase - totalSpentSinceBase;

      const todayExpenses = expenses.filter(e => e.date === defaultDateStr);
      const todayTotal = todayExpenses.reduce((sum, e) => sum + e.amount, 0);
      const todayRemaining = config.dailyLimit - todayTotal;

      const filteredWishlist = wishlist.filter(wish => activeTierFilters.includes(wish.level));

      const setPresetRange = (preset) => {
        setAnalysisPreset(preset);
        const end = defaultDateStr;
        let start = end;
        const d = new Date();
        if (preset === 'week') {
          const day = d.getDay() || 7; d.setDate(d.getDate() - day + 1); start = d.toISOString().split('T')[0];
        } else if (preset === 'month') {
          d.setDate(1); start = d.toISOString().split('T')[0];
        }
        setAnalysisDateRange({ start, end });
      };

      const analysisData = useMemo(() => {
        const filtered = expenses.filter(e => e.date >= analysisDateRange.start && e.date <= analysisDateRange.end);
        const totalSpent = filtered.reduce((sum, e) => sum + e.amount, 0);
        
        const byCategory = {};
        filtered.forEach(e => { byCategory[e.category] = (byCategory[e.category] || 0) + e.amount; });
        const categoryArray = Object.keys(byCategory).map(cat => ({
          name: cat, amount: byCategory[cat], percentage: totalSpent > 0 ? Math.round((byCategory[cat] / totalSpent) * 100) : 0
        })).sort((a, b) => b.amount - a.amount);

        const byDate = {};
        filtered.forEach(e => { byDate[e.date] = (byDate[e.date] || 0) + e.amount; });
        const dateArray = Object.keys(byDate).sort().map(d => ({ date: d, amount: byDate[d] }));
        const maxDaily = dateArray.length > 0 ? Math.max(...dateArray.map(d => d.amount)) : 0;

        return { totalSpent, categoryArray, dateArray, maxDaily, filtered };
      }, [expenses, analysisDateRange]);

      const generateLinePath = () => {
        if (analysisData.dateArray.length === 0) return "";
        return analysisData.dateArray.map((d, i) => {
          const x = (i / Math.max(1, analysisData.dateArray.length - 1)) * 100;
          const y = 100 - ((d.amount / analysisData.maxDaily) * 100);
          return `${x},${y}`;
        }).join(" ");
      };

      const exportToMarkdown = () => {
        let md = `# è²¡å‹™åˆ†æå ±å‘Š (${analysisDateRange.start} ~ ${analysisDateRange.end})\n\n`;
        md += `## ç¸½èŠ±è²»: $${analysisData.totalSpent}\n\n`;
        md += `### åˆ†é¡æ”¯å‡ºä½”æ¯”\n`;
        analysisData.categoryArray.forEach(cat => {
            md += `- **${cat.name}**: $${cat.amount} (${cat.percentage}%)\n`;
        });
        md += `\n### æ¯æ—¥èŠ±è²»è¶¨å‹¢\n`;
        if (analysisData.dateArray.length > 0) {
            analysisData.dateArray.forEach(d => { md += `- ${d.date}: $${d.amount}\n`; });
        } else {
            md += "ç„¡è³‡æ–™\n";
        }
        
        // å‰ªè²¼ç°¿é‚è¼¯
        const textArea = document.createElement("textarea");
        textArea.value = md;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showToast(t.exportSuccess);
        } catch (err) {
            console.error("è¤‡è£½å¤±æ•—", err);
            showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½");
        }
        document.body.removeChild(textArea);
      };

      // ==========================================
      // ç•«é¢æ¸²æŸ“
      // ==========================================
      if (isLoading) {
        return <div className="min-h-screen flex items-center justify-center bg-neutral-50 text-neutral-400">Loading...</div>;
      }

      return (
        <div className="min-h-screen bg-neutral-50 pb-28 font-sans text-neutral-800 flex flex-col items-center">
          
          {/* Toast æç¤ºæ¡† */}
          {toastMsg && (
            <div className="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 animate-in fade-in slide-in-from-top-5">
              <div className="bg-neutral-800 text-white text-sm px-4 py-2 rounded-full shadow-lg font-medium">
                {toastMsg}
              </div>
            </div>
          )}

          {/* é ‚éƒ¨æ¨™é¡Œ */}
          <header className="w-full max-w-md bg-white px-6 py-5 shadow-sm sticky top-0 z-40 flex justify-between items-center rounded-b-xl">
            <h1 className="text-xl font-bold text-neutral-800 tracking-wide">
              {config.nickname ? `${config.nickname} çš„${t.appTitle}` : t.appTitle}
            </h1>
            {activeTab === 'analysis' && <span className="text-sm font-medium text-neutral-400">{t.analysisTitle}</span>}
          </header>

          <main className="w-full max-w-md p-5 flex-1">
            
            {/* ================= HOME TAB ================= */}
            {activeTab === 'home' && (
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6">
                
                {/* ç›ˆé¤˜èˆ‡é ç®—å¡ç‰‡ */}
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl p-5 text-white shadow-md">
                    <p className="text-xs text-indigo-100 mb-1">{t.cumulativeSurplus}</p>
                    <p className="text-2xl font-bold">${cumulativeSurplus.toFixed(1)}</p>
                    <p className="text-[10px] text-indigo-200 mt-2">ä¾è¨­å®šèµ·å§‹æ—¥è¨ˆç®—</p>
                  </div>
                  <div className="bg-white rounded-3xl p-5 shadow-sm border border-neutral-100 flex flex-col justify-center">
                    <p className="text-xs text-neutral-400 mb-1">{t.todayRemaining}</p>
                    <p className={`text-2xl font-bold ${todayRemaining < 0 ? 'text-red-500' : 'text-neutral-800'}`}>
                      ${todayRemaining}
                    </p>
                    <p className="text-[10px] text-neutral-400 mt-2">{t.dailyBudget}: ${config.dailyLimit}</p>
                  </div>
                </div>

                {/* AI æ™ºèƒ½è¨˜å¸³å€ */}
                <div className="bg-white rounded-3xl p-5 shadow-sm border border-neutral-100">
                  <h2 className="text-sm font-bold text-neutral-700 mb-3">{t.aiEntryTitle}</h2>
                  <div className="flex gap-2">
                    <input type="text" 
                      className="flex-1 bg-neutral-50 border-none rounded-2xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-purple-200 transition-all" 
                      placeholder={t.aiPlaceholder}
                      value={aiText} onChange={e => setAiText(e.target.value)}
                      onKeyDown={e => e.key === 'Enter' && handleAIEntry()}
                    />
                    <button 
                      onClick={handleAIEntry} disabled={isAiProcessing || !aiText.trim()}
                      className={`px-4 py-2 rounded-2xl font-bold text-sm transition-all ${isAiProcessing ? 'bg-neutral-200 text-neutral-400' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}`}
                    >
                      {isAiProcessing ? '...' : t.aiBtn}
                    </button>
                  </div>
                </div>

                {/* æ‰‹å‹•è¨˜å¸³ */}
                <div className="bg-white rounded-3xl p-5 shadow-sm border border-neutral-100">
                  <h2 className="text-sm font-bold text-neutral-700 mb-4">{t.manualEntryTitle}</h2>
                  <form onSubmit={handleAddExpense} className="space-y-4">
                    <div className="flex gap-3">
                      <div className="flex-1">
                        <label className="block text-[10px] text-neutral-400 mb-1 ml-1">{t.itemName}</label>
                        <input type="text" required
                          className="w-full bg-neutral-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-100 text-sm font-medium" 
                          placeholder={t.itemName}
                          value={newExpense.item} onChange={e => setNewExpense({...newExpense, item: e.target.value})} 
                        />
                      </div>
                      <div className="w-[100px]">
                        <label className="block text-[10px] text-neutral-400 mb-1 ml-1">{t.amount}</label>
                        <input type="number" required
                          className="w-full bg-neutral-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-100 text-sm font-bold text-indigo-700" 
                          placeholder="0"
                          value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} 
                        />
                      </div>
                    </div>
                    
                    <div className="flex gap-3">
                      <div className="w-2/5">
                        <label className="block text-[10px] text-neutral-400 mb-1 ml-1">{t.category}</label>
                        <select 
                          className="w-full bg-neutral-50 rounded-xl px-3 py-3 outline-none focus:ring-2 focus:ring-indigo-100 text-sm text-neutral-700"
                          value={newExpense.category} onChange={e => setNewExpense({...newExpense, category: e.target.value})}
                        >
                          {t.categories.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                      </div>
                      <div className="flex-1">
                        <label className="block text-[10px] text-neutral-400 mb-1 ml-1">{t.note}</label>
                        <input type="text" 
                          className="w-full bg-neutral-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-100 text-sm" 
                          placeholder={t.note}
                          value={newExpense.note} onChange={e => setNewExpense({...newExpense, note: e.target.value})} 
                        />
                      </div>
                    </div>
                    
                    <button type="submit" className="w-full bg-neutral-800 text-white rounded-xl py-3.5 font-bold text-sm hover:bg-neutral-700 active:scale-[0.98] transition-all shadow-sm">
                      {t.saveBtn}
                    </button>
                  </form>
                </div>

                {/* ä»Šæ—¥æ˜ç´° */}
                {todayExpenses.length > 0 && (
                  <div>
                    <h2 className="text-sm font-bold text-neutral-500 mb-3 px-1">{t.todayDetails} (å·²èŠ±: ${todayTotal})</h2>
                    <div className="space-y-3">
                      {todayExpenses.map(expense => (
                        <div key={expense.id} className="bg-white p-4 rounded-2xl flex items-center justify-between shadow-sm border border-neutral-100">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center text-xs font-bold shrink-0">
                              {expense.category[0]}
                            </div>
                            <div className="min-w-0">
                              <p className="font-bold text-neutral-700 text-sm truncate">{expense.item}</p>
                              <div className="flex items-center gap-2 mt-0.5">
                                <span className="text-[10px] bg-neutral-100 text-neutral-500 px-1.5 py-0.5 rounded">{expense.category}</span>
                                {expense.note && <span className="text-[10px] text-neutral-400 truncate max-w-[100px]">{expense.note}</span>}
                              </div>
                            </div>
                          </div>
                          <div className="flex items-center gap-3 ml-2 shrink-0">
                            <span className="font-bold text-neutral-800">-${expense.amount}</span>
                            <button onClick={() => handleDeleteExpense(expense.id)} className="text-neutral-300 hover:text-red-400 transition-colors p-1">
                              <TrashIcon />
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* ================= WISHLIST TAB ================= */}
            {activeTab === 'wishlist' && (
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                <form onSubmit={handleAddWish} className="bg-white rounded-3xl p-5 shadow-sm border border-neutral-100 mb-6 space-y-4">
                  <div>
                    <input type="text" required
                      className="w-full bg-neutral-50 rounded-2xl px-4 py-3 outline-none focus:ring-2 focus:ring-pink-200 transition-all text-sm mb-3 font-bold" 
                      placeholder={t.wishDesc}
                      value={newWish.title} onChange={e => setNewWish({...newWish, title: e.target.value})} 
                    />
                    <textarea 
                      className="w-full bg-neutral-50 rounded-2xl px-4 py-3 outline-none focus:ring-2 focus:ring-pink-200 transition-all text-xs mb-3 resize-none h-20" 
                      placeholder={t.wishDescriptionPlaceholder}
                      value={newWish.description} onChange={e => setNewWish({...newWish, description: e.target.value})} 
                    ></textarea>
                    <input type="number" required
                      className="w-full bg-neutral-50 rounded-2xl px-4 py-3 outline-none focus:ring-2 focus:ring-pink-200 transition-all text-sm mb-4" 
                      placeholder={t.wishPrice}
                      value={newWish.price} onChange={e => setNewWish({...newWish, price: e.target.value})} 
                    />
                    
                    <p className="text-xs text-neutral-500 mb-2 ml-1">{t.wishMeaning}</p>
                    <div className="space-y-2 mb-4">
                      {t.wishTiers.map(tier => (
                        <label key={tier.level} 
                          className={`flex flex-col p-3 rounded-2xl border cursor-pointer transition-all ${
                            newWish.level === tier.level ? 'border-pink-300 bg-pink-50' : 'border-neutral-100 bg-white hover:bg-neutral-50'
                          }`}
                          onClick={() => setNewWish({...newWish, level: tier.level})}
                        >
                          <div className="flex items-center justify-between">
                            <span className="font-medium text-sm text-neutral-700">{tier.label}</span>
                            <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center ${newWish.level === tier.level ? 'border-pink-400' : 'border-neutral-300'}`}>
                              {newWish.level === tier.level && <div className="w-2 h-2 rounded-full bg-pink-400"></div>}
                            </div>
                          </div>
                          <span className="text-[10px] text-neutral-400 mt-1">{tier.desc}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                  <button type="submit" className="w-full bg-pink-500 text-white rounded-2xl py-3.5 font-bold text-sm hover:bg-pink-600 active:scale-[0.98] transition-all shadow-sm">
                    {t.wishBtn}
                  </button>
                </form>

                <div className="mb-4">
                  <p className="text-xs text-neutral-400 mb-2 ml-1">{t.wishShowTier}</p>
                  <div className="flex flex-wrap gap-2">
                    {t.wishTiers.map(tier => {
                      const isActive = activeTierFilters.includes(tier.level);
                      return (
                        <button key={tier.level}
                          onClick={() => {
                            if (isActive) setActiveTierFilters(prev => prev.filter(l => l !== tier.level));
                            else setActiveTierFilters(prev => [...prev, tier.level]);
                          }}
                          className={`px-3 py-1.5 rounded-full text-[10px] font-medium transition-all border ${
                            isActive ? 'bg-neutral-700 text-white border-neutral-700' : 'bg-white text-neutral-400 border-neutral-200'
                          }`}
                        >
                          {isActive ? 'âœ“ ' : ''}{tier.label}
                        </button>
                      );
                    })}
                  </div>
                </div>

                <div className="space-y-4">
                  {filteredWishlist.length === 0 ? (
                    <div className="text-center py-10 text-neutral-400 text-sm bg-white rounded-3xl border border-neutral-100 border-dashed">
                      {t.wishEmpty}
                    </div>
                  ) : (
                    filteredWishlist.sort((a,b) => a.level - b.level).map(wish => {
                      const currentTier = t.wishTiers.find(tier => tier.level === wish.level) || t.wishTiers[1];
                      return (
                        <WishCard 
                          key={wish.id}
                          wish={wish}
                          currentTier={currentTier}
                          onToggle={handleToggleWish}
                          onDelete={handleDeleteWish}
                          onAddSubItem={handleAddSubItem}
                          onToggleSubItem={handleToggleSubItem}
                          onDeleteSubItem={handleDeleteSubItem}
                          t={t}
                        />
                      )
                    })
                  )}
                </div>
              </div>
            )}

            {/* ================= ANALYSIS TAB ================= */}
            {activeTab === 'analysis' && (
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6">
                
                {/* å¿«é€Ÿé¸æ“‡å€é–“ */}
                <div className="flex gap-2 mb-2 overflow-x-auto pb-1 hide-scrollbar">
                  {['today', 'week', 'month', 'custom'].map(preset => {
                    const labels = { today: t.today, week: t.thisWeek, month: t.thisMonth, custom: t.customRange };
                    return (
                      <button key={preset} 
                        onClick={() => preset === 'custom' ? setAnalysisPreset('custom') : setPresetRange(preset)}
                        className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border ${
                          analysisPreset === preset ? 'bg-neutral-800 text-white border-neutral-800' : 'bg-white text-neutral-500 border-neutral-200 hover:bg-neutral-50'
                        }`}
                      >
                        {labels[preset]}
                      </button>
                    )
                  })}
                </div>

                {/* è‡ªè¨‚å€é–“é¸æ“‡å™¨ */}
                {analysisPreset === 'custom' && (
                  <div className="bg-white rounded-2xl p-4 shadow-sm border border-neutral-100 flex items-center gap-2 animate-in fade-in">
                    <input type="date" value={analysisDateRange.start} onChange={(e) => setAnalysisDateRange(prev => ({...prev, start: e.target.value}))}
                      className="flex-1 bg-neutral-50 text-neutral-700 text-xs rounded-xl px-2 py-2 outline-none border border-neutral-200"
                    />
                    <span className="text-neutral-400 text-xs">{t.to}</span>
                    <input type="date" value={analysisDateRange.end} onChange={(e) => setAnalysisDateRange(prev => ({...prev, end: e.target.value}))}
                      className="flex-1 bg-neutral-50 text-neutral-700 text-xs rounded-xl px-2 py-2 outline-none border border-neutral-200"
                    />
                  </div>
                )}

                {/* ç¸½èŠ±è²»å¡ç‰‡ & åŒ¯å‡ºæŒ‰éˆ• */}
                <div className="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-3xl p-6 text-white shadow-md relative overflow-hidden">
                  <div className="relative z-10">
                    <p className="text-emerald-100 text-sm font-medium mb-1">{t.totalSpentRange}</p>
                    <p className="text-4xl font-bold">${analysisData.totalSpent}</p>
                    <p className="text-xs text-emerald-100 mt-2 opacity-80">{analysisData.filtered.length} ç­†ç´€éŒ„</p>
                  </div>
                  <button 
                    onClick={exportToMarkdown}
                    className="absolute top-4 right-4 bg-white/20 hover:bg-white/30 p-2 rounded-xl backdrop-blur-sm transition-all flex items-center gap-2 text-xs font-bold"
                  >
                    <CopyIcon /> {t.exportBtn}
                  </button>
                </div>

                {/* é•·æ¢åœ–ï¼šåˆ†é¡å æ¯” */}
                <div className="bg-white p-5 rounded-3xl shadow-sm border border-neutral-100">
                  <h3 className="text-sm font-bold text-neutral-700 mb-4 flex items-center gap-2">
                    <ChartIcon /> {t.chartCategory}
                  </h3>
                  {analysisData.categoryArray.length === 0 ? (
                    <p className="text-center text-xs text-neutral-400 py-4">ç„¡è³‡æ–™</p>
                  ) : (
                    <div className="space-y-3">
                      {analysisData.categoryArray.map(cat => (
                        <div key={cat.name}>
                          <div className="flex justify-between items-end mb-1">
                            <span className="text-xs font-bold text-neutral-700">{cat.name}</span>
                            <div className="text-right">
                              <span className="text-xs font-bold text-neutral-700">${cat.amount}</span>
                              <span className="text-[10px] text-neutral-400 ml-2">{cat.percentage}%</span>
                            </div>
                          </div>
                          <div className="w-full bg-neutral-100 rounded-full h-1.5 overflow-hidden">
                            <div className="bg-teal-400 h-1.5 rounded-full" style={{ width: `${cat.percentage}%` }}></div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* æŠ˜ç·šåœ–ï¼šæ¯æ—¥è¶¨å‹¢ */}
                <div className="bg-white p-5 rounded-3xl shadow-sm border border-neutral-100">
                  <h3 className="text-sm font-bold text-neutral-700 mb-4 flex items-center gap-2">
                    <ChartIcon /> {t.chartTrend}
                  </h3>
                  {analysisData.dateArray.length === 0 ? (
                    <p className="text-center text-xs text-neutral-400 py-4">ç„¡è³‡æ–™</p>
                  ) : (
                    <div className="relative h-32 w-full mt-4 border-b border-l border-neutral-200">
                      <svg className="w-full h-full overflow-visible" preserveAspectRatio="none" viewBox="0 0 100 100">
                        <polyline
                          fill="none" stroke="#2dd4bf" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
                          points={generateLinePath()}
                        />
                        {/* æ•¸æ“šé» */}
                        {analysisData.dateArray.map((d, i) => {
                          const x = (i / Math.max(1, analysisData.dateArray.length - 1)) * 100;
                          const y = 100 - ((d.amount / analysisData.maxDaily) * 100);
                          return <circle key={i} cx={x} cy={y} r="1.5" fill="#0f766e" />;
                        })}
                      </svg>
                      {/* Yè»¸æ¨™ç±¤ */}
                      <div className="absolute top-0 -left-1 transform -translate-x-full text-[8px] text-neutral-400">${analysisData.maxDaily}</div>
                      <div className="absolute bottom-0 -left-1 transform -translate-x-full translate-y-1/2 text-[8px] text-neutral-400">$0</div>
                    </div>
                  )}
                </div>

              </div>
            )}

            {/* ================= SETTINGS TAB ================= */}
            {activeTab === 'settings' && (
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6">
                
                {/* åŸºæœ¬è¨­å®š */}
                <div className="bg-white rounded-3xl p-5 shadow-sm border border-neutral-100 space-y-4">
                  <div>
                    <label className="block text-xs font-bold text-neutral-700 mb-1.5">{t.nickname}</label>
                    <input type="text" 
                      className="w-full bg-neutral-50 rounded-xl px-4 py-2.5 outline-none focus:ring-2 focus:ring-neutral-200 text-sm border border-transparent" 
                      value={config.nickname || ''} placeholder="è¨­å®šæ‚¨çš„ç¨±å‘¼"
                      onChange={e => setConfig({...config, nickname: e.target.value})} 
                      onBlur={(e) => saveConfig({nickname: e.target.value})}
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-bold text-neutral-700 mb-1.5">{t.dailyBudget} ($)</label>
                    <input type="number" 
                      className="w-full bg-neutral-50 rounded-xl px-4 py-2.5 outline-none focus:ring-2 focus:ring-neutral-200 text-sm font-medium border border-transparent" 
                      value={config.dailyLimit} 
                      onChange={e => setConfig({...config, dailyLimit: Number(e.target.value)})} 
                      onBlur={(e) => saveConfig({dailyLimit: Number(e.target.value)})}
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-[10px] text-neutral-500 mb-1">{t.baseDate}</label>
                      <input type="date" 
                        className="w-full bg-neutral-50 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-neutral-200 text-xs border border-transparent" 
                        value={config.baseDate} 
                        onChange={e => setConfig({...config, baseDate: e.target.value})} 
                        onBlur={(e) => saveConfig({baseDate: e.target.value})}
                      />
                    </div>
                    <div>
                      <label className="block text-[10px] text-neutral-500 mb-1">{t.baseBalance}</label>
                      <input type="number" 
                        className="w-full bg-neutral-50 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-neutral-200 text-xs border border-transparent" 
                        value={config.baseBalance} 
                        onChange={e => setConfig({...config, baseBalance: Number(e.target.value)})} 
                        onBlur={(e) => saveConfig({baseBalance: Number(e.target.value)})}
                      />
                    </div>
                  </div>
                  <div>
                    <label className="block text-xs font-bold text-neutral-700 mb-1.5">{t.language}</label>
                    <select 
                      className="w-full bg-neutral-50 rounded-xl px-4 py-2.5 outline-none focus:ring-2 focus:ring-neutral-200 text-sm"
                      value={config.language} 
                      onChange={(e) => saveConfig({language: e.target.value})}
                    >
                      <option value="zh">ç¹é«”ä¸­æ–‡</option>
                      <option value="en">English</option>
                    </select>
                  </div>
                </div>

                {/* å¸³æˆ¶å€å¡Š */}
                <div className="bg-neutral-100 rounded-3xl p-5 border border-neutral-200 flex flex-col gap-3">
                  <div className="flex items-center gap-3 mb-2">
                    {user?.photoURL ? 
                      <img src={user.photoURL} className="w-10 h-10 rounded-full shadow-sm" alt="user"/> : 
                      <div className="w-10 h-10 rounded-full bg-neutral-300 flex items-center justify-center text-white"><SettingsIcon /></div>
                    }
                    <div>
                      <p className="text-xs font-bold text-neutral-800">{user?.displayName || t.anonymous}</p>
                      <p className="text-[10px] text-neutral-500">{user?.email || 'æœªå‚™ä»½åˆ°é›²ç«¯ï¼Œè³‡æ–™åƒ…å­˜æ–¼æœ¬æ©Ÿ'}</p>
                    </div>
                  </div>
                  {user?.isAnonymous ? (
                    <button onClick={handleGoogleLogin} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold text-xs rounded-xl shadow-sm transition-colors">
                      {t.loginGoogle}
                    </button>
                  ) : (
                    <button onClick={handleLogout} className="w-full py-3 bg-white hover:bg-rose-50 text-rose-500 border border-rose-100 font-bold text-xs rounded-xl shadow-sm transition-colors">
                      {t.logout}
                    </button>
                  )}
                </div>
              </div>
            )}

          </main>

          {/* ================= BOTTOM NAVIGATION ================= */}
          <nav className="fixed bottom-0 w-full max-w-md bg-white border-t border-neutral-100 px-6 py-3 flex justify-between items-center z-50 rounded-t-2xl shadow-[0_-4px_20px_rgba(0,0,0,0.03)]">
            {[
              { id: 'home', icon: <HomeIcon />, label: t.navHome, color: 'text-indigo-600', bg: 'bg-indigo-50' },
              { id: 'wishlist', icon: <StarIcon />, label: t.navWish, color: 'text-pink-600', bg: 'bg-pink-50' },
              { id: 'analysis', icon: <ChartIcon />, label: t.navAnalysis, color: 'text-teal-600', bg: 'bg-teal-50' },
              { id: 'settings', icon: <SettingsIcon />, label: t.navSettings, color: 'text-neutral-800', bg: 'bg-neutral-100' }
            ].map(tab => (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                className={`flex flex-col items-center gap-1 p-2 rounded-2xl transition-all duration-300 ${activeTab === tab.id ? `${tab.bg} ${tab.color} scale-110 shadow-sm` : 'text-neutral-400 hover:bg-neutral-50'}`}
              >
                {tab.icon}
                <span className={`text-[10px] font-medium ${activeTab === tab.id ? 'opacity-100' : 'opacity-0 h-0 overflow-hidden'}`}>{tab.label}</span>
              </button>
            ))}
          </nav>

        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
