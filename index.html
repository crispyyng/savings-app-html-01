<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ÂÑ≤ËìÑÂä©Êâã (ÂñÆ‰∏ÄÊ™îÊ°àÂÆåÊï¥Áâà)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    /* Èö±ËóèÊç≤Ëª∏‰ΩÜ‰øùÊåÅÂèØÊªæÂãï */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* Á¢∫‰øùÂú® iOS ‰∏äËº∏ÂÖ•ÊôÇ‰∏çÊúÉËá™ÂãïÊîæÂ§ß */
    input, select, textarea { font-size: 16px !important; }
  </style>
</head>
<body class="bg-neutral-50 text-neutral-800 font-sans antialiased">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
      GoogleAuthProvider, linkWithPopup, signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const { useState, useEffect, useMemo, useRef } = React;

    // ==========================================
    // 1. Firebase & Ê†∏ÂøÉË®≠ÂÆö
    // ==========================================
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyD5iLIBqMK__fqyRUObXnO9S55Rne0gQnY",
      authDomain: "my-savings-app-138fd.firebaseapp.com",
      projectId: "my-savings-app-138fd",
      storageBucket: "my-savings-app-138fd.firebasestorage.app",
      messagingSenderId: "610693434561",
      appId: "1:610693434561:web:00221b38ee48d3cb875840",
      measurementId: "G-4FV1FGDX28"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-local-savings-app';
    const apiKey = ""; // Gemini API Key

    // ==========================================
    // 2. ÈùúÊÖãË≥áÊ∫êËàáÂ≠óÂÖ∏
    // ==========================================
    const CATEGORIES = {
      zh: ["Âü∫Êú¨ÁîüÊ¥ª", "Á§æ‰∫§/Â®õÊ®Ç", "Á™ÅÁôº/Á∑äÊÄ•", "Âõ∫ÂÆöÊîØÂá∫", "ÂÖ∂‰ªñ"],
      en: ["Living", "Social/Fun", "Emergency", "Fixed", "Other"]
    };

    const dict = {
      zh: {
        appTitle: "ÂÑ≤ËìÑÂä©Êâã", analysisTitle: "Êï∏ÊìöÂàÜÊûê", dailyBudget: "ÊØèÊó•È†êÁÆó", todayRemaining: "‰ªäÊó•Ââ©È§òÈ†êÁÆó",
        cumulativeSurplus: "Á¥ØÁ©çÂèØÁî®ÁõàÈ§ò", aiEntryTitle: "ü§ñ AI Êô∫ËÉΩË®òÂ∏≥", aiPlaceholder: "‰æãÔºöÂçàÈ§êÊª∑ËÇâÈ£Ø 120ÂÖÉ",
        aiBtn: "Ëß£Êûê", manualEntryTitle: "üí∏ ÊâãÂãïË®òÂ∏≥", itemName: "È†ÖÁõÆÂêçÁ®±", amount: "ÈáëÈ°ç", category: "ÂàÜÈ°û",
        note: "ÂÇôË®ª", saveBtn: "ÂÑ≤Â≠òÁ¥ÄÈåÑ", todayDetails: "‰ªäÊó•ÊòéÁ¥∞", wishTitle: "ÂøÉÈ°òÊ∏ÖÂñÆ", wishDesc: "ÊÉ≥Ë≤∑‰ªÄÈ∫ºÔºü",
        wishDescriptionPlaceholder: "Ë£úÂÖÖÊèèËø∞ (‰æãÂ¶Ç: ÂûãËôü„ÄÅÈ°èËâ≤„ÄÅË≥ºË≤∑ÂéüÂõ†)",
        wishPrice: "È†ê‰º∞ÈáëÈ°ç", wishMeaning: "ÈÄôÂÄãÂøÉÈ°òÂ∞ç‰Ω†ÁöÑÊÑèÁæ©Ôºü", wishBtn: "Âä†ÂÖ•ÂøÉÈ°òÊ∏ÖÂñÆ",
        wishEmpty: "ÁõÆÂâçÊ≤íÊúâÁ¨¶ÂêàÁöÑÂøÉÈ°òÔºåÁπºÁ∫å‰øùÊåÅÔºÅ", wishShowTier: "È°ØÁ§∫Â±§Á¥öÔºö", addSubItem: "Êñ∞Â¢ûÂ≠ê‰ªªÂãô (Êåâ Enter)",
        today: "‰ªäÊó•", thisWeek: "Êú¨ÈÄ±", thisMonth: "Êú¨Êúà", customRange: "Ëá™Ë®Ç", to: "Ëá≥",
        totalSpentRange: "ÂçÄÈñìÁ∏ΩËä±Ë≤ª", chartCategory: "ÂàÜÈ°ûÊîØÂá∫‰ΩîÊØî", chartTrend: "ÊØèÊó•Ëä±Ë≤ªË∂®Âã¢",
        settings: "Ë®≠ÂÆö", nickname: "ÊÇ®ÁöÑÁ®±Âëº", baseDate: "Ë®àÁÆóËµ∑ÂßãÊó•", baseBalance: "ÂàùÂßãÈ§òÈ°ç (ÂèØÂ°´Ë≤†Êï∏)",
        language: "Ë™ûË®Ä", loginGoogle: "‰ΩøÁî® Google ÁôªÂÖ•‰∏¶ÂêåÊ≠•", logout: "ÁôªÂá∫ (ÂõûÂà∞Ë®™ÂÆ¢)", anonymous: "Ë®™ÂÆ¢ (Êú™ÁôªÂÖ•)",
        navHome: "Êó•Â∏∏", navWish: "ÂøÉÈ°ò", navAnalysis: "ÂàÜÊûê", navSettings: "Ë®≠ÂÆö",
        exportBtn: "Ë§áË£ΩÁÇ∫ Markdown", exportSuccess: "Â∑≤Ë§áË£ΩÔºÅË´ãÂ∞áÂÖßÂÆπË≤ºÁµ¶ AI",
        wishTiers: [
          { level: 1, label: "üåü ÂøÖÂÇô/ÊäïË≥á", desc: "ÊèêÂçáÁîüÊ¥ªÂìÅË≥™ÊàñÂ∑•‰ΩúÊïàÁéáÁöÑÂøÖÈúÄÂìÅ" },
          { level: 2, label: "üòä ÊÉ≥Ë¶Å/È´îÈ©ó", desc: "Â∏∂‰æÜÂø´Ê®ÇÁöÑÈ´îÈ©óÊàñÂñúÊ≠°ÁöÑÁâ©ÂìÅ" },
          { level: 3, label: "ü§î Ë°ùÂãï/ËßÄÊúõ", desc: "Á™ÅÁÑ∂ÊÉ≥Ë≤∑‰ΩÜÂèØ‰ª•ÂÜçÁ≠â‰∏Ä‰∏ãÁöÑÊù±Ë•ø" }
        ], categories: CATEGORIES.zh
      },
      en: {
        appTitle: "Savings App", analysisTitle: "Data Analysis", dailyBudget: "Daily Budget", todayRemaining: "Today's Remaining",
        cumulativeSurplus: "Cumulative Surplus", aiEntryTitle: "ü§ñ AI Entry", aiPlaceholder: "e.g., Lunch burger $15",
        aiBtn: "Parse", manualEntryTitle: "üí∏ Manual Entry", itemName: "Item Name", amount: "Amount", category: "Category",
        note: "Note", saveBtn: "Save Record", todayDetails: "Today's Details", wishTitle: "Wishlist", wishDesc: "What do you want?",
        wishDescriptionPlaceholder: "Description (e.g., model, color)",
        wishPrice: "Est. Price", wishMeaning: "Meaning to you?", wishBtn: "Add to Wishlist",
        wishEmpty: "No wishes matched. Keep it up!", wishShowTier: "Show Tiers:", addSubItem: "Add sub-task (Press Enter)",
        today: "Today", thisWeek: "This Week", thisMonth: "This Month", customRange: "Custom", to: "to",
        totalSpentRange: "Total Spent", chartCategory: "Category Breakdown", chartTrend: "Daily Trend",
        settings: "Settings", nickname: "Nickname", baseDate: "Base Date", baseBalance: "Base Balance",
        language: "Language", loginGoogle: "Login with Google & Sync", logout: "Logout (Guest mode)", anonymous: "Guest",
        navHome: "Home", navWish: "Wishlist", navAnalysis: "Analysis", navSettings: "Settings",
        exportBtn: "Copy as Markdown", exportSuccess: "Copied! Paste to your AI.",
        wishTiers: [
          { level: 1, label: "üåü Essential", desc: "Improves life or work efficiency" },
          { level: 2, label: "üòä Desire", desc: "Brings joy or favorite items" },
          { level: 3, label: "ü§î Impulse", desc: "Want it now but can wait" }
        ], categories: CATEGORIES.en
      }
    };

    // ==========================================
    // 3. ÂÖ±Áî® SVG ÂúñÁ§∫ÁµÑ‰ª∂
    // ==========================================
    const HomeIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
    const StarIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>;
    const ChartIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>;
    const SettingsIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
    const TrashIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
    const CheckIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
    const PlusIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
    const CopyIcon = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>;
    const EditIcon = () => <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
    const PlusIcon = () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
    // ==========================================
    // 4. ÂñÆ‰∏ÄÂøÉÈ°òÂç°ÁâáÁµÑ‰ª∂
    // ==========================================
    const WishCard = ({ wish, currentTier, onToggle, onDelete, onAddSubItem, onToggleSubItem, onDeleteSubItem, t }) => {
      const [newSubText, setNewSubText] = useState('');

      const handleAdd = (e) => {
        if (e.key === 'Enter' && newSubText.trim()) {
          e.preventDefault();
          onAddSubItem(wish.id, newSubText.trim());
          setNewSubText('');
        }
      };

      const completedSubCount = (wish.subItems || []).filter(s => s.isCompleted).length;
      const totalSubCount = (wish.subItems || []).length;
      const progressPercent = totalSubCount > 0 ? Math.round((completedSubCount / totalSubCount) * 100) : 0;

      return (
        <div className={`bg-white p-4 rounded-3xl flex flex-col gap-3 shadow-sm border transition-all ${wish.isCompleted ? 'border-green-200 bg-green-50/30' : 'border-neutral-100'}`}>
          <div className="flex items-start gap-3">
            <button onClick={() => onToggle(wish.id, wish.isCompleted)} className={`mt-1 flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${wish.isCompleted ? 'border-green-500 bg-green-500 text-white' : 'border-neutral-300 text-transparent'}`}><CheckIcon /></button>
            <div className="flex-1 min-w-0">
              <span className="text-[10px] text-pink-500 font-medium bg-pink-50 px-2 py-0.5 rounded-full">{currentTier.label.split(' ')[0]}</span>
              <p className={`font-bold text-base mt-1.5 ${wish.isCompleted ? 'text-neutral-400 line-through' : 'text-neutral-800'}`}>{wish.title}</p>
              {wish.description && <p className="text-xs text-neutral-500 mt-1 leading-relaxed">{wish.description}</p>}
            </div>
            <div className="text-right flex flex-col items-end">
              <p className={`text-sm ${wish.isCompleted ? 'text-neutral-300' : 'text-neutral-800 font-bold'}`}>${wish.price}</p>
              <button onClick={() => onDelete(wish.id)} className="text-neutral-300 hover:text-red-400 mt-2 p-1"><TrashIcon /></button>
            </div>
          </div>
          <div className="mt-2 pl-9">
            {totalSubCount > 0 && (
              <div className="mb-3">
                <div className="flex justify-between text-[10px] text-neutral-400 mb-1 font-medium"><span>ÈÄ≤Â∫¶</span><span>{completedSubCount} / {totalSubCount}</span></div>
                <div className="w-full bg-neutral-100 rounded-full h-1"><div className="bg-pink-400 h-1 rounded-full transition-all duration-300" style={{ width: `${progressPercent}%` }}></div></div>
              </div>
            )}
            <div className="space-y-2 mb-2">
              {(wish.subItems || []).map(sub => (
                <div key={sub.id} className="flex items-center gap-2 group">
                  <button onClick={() => onToggleSubItem(wish.id, sub.id, sub.isCompleted)} className={`w-4 h-4 rounded border flex items-center justify-center transition-colors ${sub.isCompleted ? 'border-pink-500 bg-pink-500 text-white' : 'border-neutral-300 text-transparent'}`}><CheckIcon /></button>
                  <span className={`text-xs flex-1 truncate ${sub.isCompleted ? 'text-neutral-400 line-through' : 'text-neutral-600'}`}>{sub.text}</span>
                  <button onClick={() => onDeleteSubItem(wish.id, sub.id)} className="text-neutral-200 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity p-0.5"><TrashIcon /></button>
                </div>
              ))}
            </div>
            <div className="relative">
              <div className="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none text-neutral-400"><PlusIcon /></div>
              <input type="text" value={newSubText} onChange={e => setNewSubText(e.target.value)} onKeyDown={handleAdd} placeholder={t.addSubItem} className="w-full bg-neutral-50 text-xs rounded-xl pl-7 pr-3 py-2 outline-none focus:bg-white focus:ring-1 focus:ring-pink-200 transition-all border border-transparent focus:border-pink-100" />
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // 5. ÊáâÁî®Á®ãÂºè‰∏ªÈ´î
    // ==========================================
    const App = () => {
      const [isLoading, setIsLoading] = useState(true);
      const [user, setUser] = useState(null);
      const [activeTab, setActiveTab] = useState('settings'); // ÁÇ∫‰∫ÜÊñπ‰æøÊÇ®Ê∏¨Ë©¶ÔºåÈ†êË®≠ÂÖàË∑≥ËΩâÂà∞Ë®≠ÂÆöÈ†ÅÈù¢
      const [expenses, setExpenses] = useState([]);
      const [wishlist, setWishlist] = useState([]);
      const [toastMsg, setToastMsg] = useState('');
      const [isExpenseModalOpen, setExpenseModalOpen] = useState(false);
      const [editingExpense, setEditingExpense] = useState(null); 
      const [isWishModalOpen, setWishModalOpen] = useState(false);
      const [editingWish, setEditingWish] = useState(null);
      const defaultDateStr = new Date().toISOString().split('T')[0];
      const [config, setConfig] = useState({
        language: 'zh', dailyLimit: 300, baseDate: defaultDateStr, baseBalance: 0, nickname: ''
      });
      const t = dict[config.language] || dict.zh;

      const [activeTierFilters, setActiveTierFilters] = useState([1, 2, 3]);
      const [newExpense, setNewExpense] = useState({ item: '', amount: '', category: t.categories[0], note: '', date: defaultDateStr });
      const [newWish, setNewWish] = useState({ title: '', description: '', price: '', level: 2 });
      const [aiText, setAiText] = useState('');
      const [isAiProcessing, setIsAiProcessing] = useState(false);

      const [analysisPreset, setAnalysisPreset] = useState('month');
      const [analysisDateRange, setAnalysisDateRange] = useState({
        start: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0],
        end: defaultDateStr
      });

      // ËºîÂä©ÂäüËÉΩ
      const showToast = (msg) => {
        setToastMsg(msg);
        setTimeout(() => setToastMsg(''), 4000);
      };

      // ==========================================
      // ÂàùÂßãÂåñËàáË™çË≠âÈÇèËºØ
      // ==========================================
      useEffect(() => {
        const initAuth = async () => {
          try {
            // Â¶ÇÊûúÁí∞Â¢ÉÊúâÊèê‰æõÂº∑Âà∂ TokenÔºåÂÑ™ÂÖà‰ΩøÁî®
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else {
              // Ëã•ÁÑ°ÁôªÂÖ•ÁãÄÊÖãÔºåÈ†êË®≠ÂïüÁî®ÂåøÂêçÁôªÂÖ• (Ë®™ÂÆ¢)
              if (!auth.currentUser) {
                await signInAnonymously(auth);
              }
            }
          } catch (error) {
            console.error("Auth error:", error);
            showToast("È©óË≠âÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÁ∂≤È†Å");
          }
        };
        initAuth();

        const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
          setUser(currentUser);
          setIsLoading(false);
          // Â¶ÇÊûúÂÅµÊ∏¨Âà∞‰ΩøÁî®ËÄÖËÆäÊàê nullÔºåËá™ÂãïÂª∫Á´ãÊñ∞ÁöÑÂåøÂêç‰ΩøÁî®ËÄÖÔºåÁ¢∫‰øùÂèØ‰ª•ÁπºÁ∫åË®òÂ∏≥
          if (!currentUser && typeof __initial_auth_token === 'undefined') {
            signInAnonymously(auth).catch(e => console.error(e));
          }
        });
        return () => unsubscribe();
      }, []);

      // Google ÁôªÂÖ•
      const handleGoogleLogin = async () => {
        try {
          const provider = new GoogleAuthProvider();
          await signInWithPopup(auth, provider);
          showToast("üéâ ÁôªÂÖ•ÊàêÂäüÔºÅË≥áÊñôÂ∑≤ÂêåÊ≠•");
        } catch (error) {
          console.error("Google Login Error:", error);
          if (error.code === 'auth/popup-closed-by-user') {
            showToast("ÁôªÂÖ•Â∑≤ÂèñÊ∂à");
          } else if (error.code === 'auth/unauthorized-domain') {
            showToast("‚ö†Ô∏è Á∂≤ÂüüÊú™ÊéàÊ¨äÔºÅË´ãÂú® Firebase ÂæåÂè∞Ë®≠ÂÆö‰∏≠Âä†ÂÖ•Ê≠§Á∂≤Âüü");
          } else if (error.code === 'auth/operation-not-allowed') {
            showToast("‚ö†Ô∏è Firebase ÂæåÂè∞Â∞öÊú™ÂïüÁî® Google ÁôªÂÖ•ÂäüËÉΩ");
          } else {
            showToast("ÁôªÂÖ•Â§±ÊïóÔºöÁî±ÊñºÁÄèË¶ΩÂô®ÂÆâÂÖ®ÈôêÂà∂ÔºåÈ†êË¶ΩÁí∞Â¢É‰∏≠ÂèØËÉΩÁÑ°Ê≥ïÂΩàÂá∫Ë¶ñÁ™ó„ÄÇË´ãÂú®Êú¨Âú∞Á´ØÊàñÁç®Á´ãÂàÜÈ†ÅÈñãÂïü„ÄÇ");
          }
        }
      };

      // ÁôªÂá∫
      const handleLogout = async () => {
        try {
          await signOut(auth);
          // ÁôªÂá∫ÂæåÊúÉÈÄèÈÅé onAuthStateChanged Ëá™ÂãïËß∏ÁôºÂª∫Á´ãÊñ∞ÁöÑÂåøÂêç‰ΩøÁî®ËÄÖ
          showToast("Â∑≤ÁôªÂá∫Â∏≥ËôüÔºåÁ≥ªÁµ±Â∑≤ÁÇ∫ÊÇ®ÂàáÊèõËá≥Ë®™ÂÆ¢Ê®°Âºè");
        } catch (error) {
          console.error("Logout Error:", error);
          showToast("ÁôªÂá∫Â§±ÊïóÔºåË´ãÈáçË©¶");
        }
      };

      useEffect(() => {
        if (!user) return;
        const expensesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'expenses');
        const unsubExpenses = onSnapshot(expensesRef, (snapshot) => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setExpenses(data.sort((a, b) => new Date(b.date) - new Date(a.date)));
        }, (error) => console.error(error));

        const wishlistRef = collection(db, 'artifacts', appId, 'users', user.uid, 'wishlist');
        const unsubWishlist = onSnapshot(wishlistRef, (snapshot) => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setWishlist(data);
        }, (error) => console.error(error));

        const configRef = doc(db, 'artifacts', appId, 'users', user.uid, 'config', 'userConfig');
        const unsubConfig = onSnapshot(configRef, (docSnap) => {
          if (docSnap.exists()) {
            const dbConfig = docSnap.data();
            setConfig(prev => ({ ...prev, ...dbConfig }));
            if (dbConfig.language && dbConfig.language !== config.language) {
               setNewExpense(prev => ({...prev, category: dict[dbConfig.language].categories[0]}));
            }
          }
        }, (error) => console.error(error));

        return () => { unsubExpenses(); unsubWishlist(); unsubConfig(); };
      }, [user]);

      // ==========================================
      // Êó•Â∏∏Ë®òÂ∏≥ÈÇèËºØ
      // ==========================================
      const handleAddExpense = async (e) => {
        e.preventDefault();
        if (!user || !newExpense.amount || !newExpense.item) return;
        try {
          await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'expenses'), {
            item: newExpense.item, amount: Number(newExpense.amount), category: newExpense.category,
            note: newExpense.note, date: newExpense.date, createdAt: new Date().toISOString()
          });
          setNewExpense({ ...newExpense, item: '', amount: '', note: '' });
          showToast("Ë®òÂ∏≥ÊàêÂäüÔºÅ");
        } catch (error) { console.error("Error adding expense:", error); }
      };

      const handleDeleteExpense = async (id) => {
        if (!user) return;
        await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'expenses', id));
      };

      const handleAIEntry = async () => {
        if (!aiText.trim() || !user) return;
        setIsAiProcessing(true);
        try {
          const prompt = `Parse this expense input: "${aiText}". Current Date: ${defaultDateStr}. Valid Categories: ${t.categories.join(', ')}. Return ONLY a JSON object with keys: "item" (string), "amount" (number), "category" (string, strictly match one of the valid categories), "date" (YYYY-MM-DD).`;
          
          const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
          const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
          });
          
          if (!res.ok) throw new Error("API request failed");
          const data = await res.json();
          const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
          
          if (resultText) {
            const parsed = JSON.parse(resultText);
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'expenses'), {
              item: parsed.item || "AI Ë®òÂ∏≥", amount: Number(parsed.amount),
              category: t.categories.includes(parsed.category) ? parsed.category : t.categories[0],
              note: "Áî± AI Âª∫Á´ã", date: parsed.date || defaultDateStr, createdAt: new Date().toISOString()
            });
            setAiText('');
            showToast("AI Ëß£Êûê‰∏¶Ë®òÂ∏≥ÊàêÂäüÔºÅ");
          }
        } catch (error) {
          console.error("AI Parse Error:", error);
          showToast("AI Ëß£ÊûêÂ§±ÊïóÔºåË´ãÊâãÂãïËº∏ÂÖ•");
        } finally {
          setIsAiProcessing(false);
        }
      };

      // ==========================================
      // ÂøÉÈ°òÊ∏ÖÂñÆÈÇèËºØ
      // ==========================================
      const saveExpense = async (data) => {
        if (!user) return;
        try {
          if (editingExpense) {
            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'expenses', editingExpense.id), data);
          } else {
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'expenses'), { ...data, createdAt: Date.now() });
          }
          setExpenseModalOpen(false);
          setEditingExpense(null);
        } catch (error) { console.error(error); }
      };

      const saveWishItem = async (data) => {
        if (!user) return;
        try {
          if (editingWish) {
             await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'wishlist', editingWish.id), data);
          } else {
             await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'wishlist'), { ...data, createdAt: Date.now(), saved: 0 });
          }
          setWishModalOpen(false);
          setEditingWish(null);
        } catch (error) { console.error(error); }
      };

      const updateWishSaved = async (id, currentSaved, price, increment) => {
        if (!user) return;
        const newSaved = Math.max(0, Math.min(price, currentSaved + increment));
        try { await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'wishlist', id), { saved: newSaved }); } catch (error) {}
      };

      const handleAddSubItem = async (wishId, currentSubItems, newName, newAmount) => {
          if (!newName || !newAmount) return;
          const updated = [...(currentSubItems || []), { id: Date.now().toString(), name: newName, amount: Number(newAmount) }];
          try { await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'wishlist', wishId), { subItems: updated }); } catch(e) {}
      };

      const handleDeleteSubItem = async (wishId, currentSubItems, subId) => {
          const updated = (currentSubItems || []).filter(item => item.id !== subId);
          try { await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'wishlist', wishId), { subItems: updated }); } catch(e) {}
      };

      const openEditExpense = (expense) => { setEditingExpense(expense); setExpenseModalOpen(true); };
      const openEditWish = (wish) => { setEditingWish(wish); setWishModalOpen(true); };
      
      const deleteItem = async (collectionName, id) => {
        if (!user) return;
        await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, collectionName, id));
      };

      // ==========================================
      // Ë®≠ÂÆöËàáÂàÜÊûêÈÇèËºØ
      // ==========================================
      const saveConfig = async (newSettings) => {
        if (!user) return;
        const updated = { ...config, ...newSettings };
        setConfig(updated);
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'config', 'userConfig'), updated);
        } catch (error) {
          await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'config'), updated);
        }
      };

      const baseDateObj = new Date(config.baseDate || defaultDateStr);
      const todayObj = new Date(defaultDateStr);
      const diffTime = Math.max(0, todayObj - baseDateObj);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      const totalBudgetSinceBase = diffDays * config.dailyLimit;
      const expensesSinceBase = expenses.filter(e => e.date >= config.baseDate);
      const totalSpentSinceBase = expensesSinceBase.reduce((sum, e) => sum + e.amount, 0);
      const cumulativeSurplus = (config.baseBalance || 0) + totalBudgetSinceBase - totalSpentSinceBase;

      const todayExpenses = expenses.filter(e => e.date === defaultDateStr);
      const todayTotal = todayExpenses.reduce((sum, e) => sum + e.amount, 0);
      const todayRemaining = config.dailyLimit - todayTotal;

      const filteredWishlist = wishlist.filter(wish => activeTierFilters.includes(wish.level));

      const setPresetRange = (preset) => {
        setAnalysisPreset(preset);
        const end = defaultDateStr;
        let start = end;
        const d = new Date();
        if (preset === 'week') {
          const day = d.getDay() || 7; d.setDate(d.getDate() - day + 1); start = d.toISOString().split('T')[0];
        } else if (preset === 'month') {
          d.setDate(1); start = d.toISOString().split('T')[0];
        }
        setAnalysisDateRange({ start, end });
      };

      const analysisData = useMemo(() => {
        const filtered = expenses.filter(e => e.date >= analysisDateRange.start && e.date <= analysisDateRange.end);
        const totalSpent = filtered.reduce((sum, e) => sum + e.amount, 0);
        
        const byCategory = {};
        filtered.forEach(e => { byCategory[e.category] = (byCategory[e.category] || 0) + e.amount; });
        const categoryArray = Object.keys(byCategory).map(cat => ({
          name: cat, amount: byCategory[cat], percentage: totalSpent > 0 ? Math.round((byCategory[cat] / totalSpent) * 100) : 0
        })).sort((a, b) => b.amount - a.amount);

        const byDate = {};
        filtered.forEach(e => { byDate[e.date] = (byDate[e.date] || 0) + e.amount; });
        const dateArray = Object.keys(byDate).sort().map(d => ({ date: d, amount: byDate[d] }));
        const maxDaily = dateArray.length > 0 ? Math.max(...dateArray.map(d => d.amount)) : 0;

        return { totalSpent, categoryArray, dateArray, maxDaily, filtered };
      }, [expenses, analysisDateRange]);

      const generateLinePath = () => {
        if (analysisData.dateArray.length === 0) return "";
        return analysisData.dateArray.map((d, i) => {
          const x = (i / Math.max(1, analysisData.dateArray.length - 1)) * 100;
          const y = 100 - ((d.amount / analysisData.maxDaily) * 100);
          return `${x},${y}`;
        }).join(" ");
      };

      const exportToMarkdown = () => {
        let md = `# Ë≤°ÂãôÂàÜÊûêÂ†±Âëä (${analysisDateRange.start} ~ ${analysisDateRange.end})\n\n`;
        md += `## Á∏ΩËä±Ë≤ª: $${analysisData.totalSpent}\n\n`;
        md += `### ÂàÜÈ°ûÊîØÂá∫‰ΩîÊØî\n`;
        analysisData.categoryArray.forEach(cat => {
            md += `- **${cat.name}**: $${cat.amount} (${cat.percentage}%)\n`;
        });
        md += `\n### ÊØèÊó•Ëä±Ë≤ªË∂®Âã¢\n`;
        if (analysisData.dateArray.length > 0) {
            analysisData.dateArray.forEach(d => { md += `- ${d.date}: $${d.amount}\n`; });
        } else {
            md += "ÁÑ°Ë≥áÊñô\n";
        }
        
        const textArea = document.createElement("textarea");
        textArea.value = md;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showToast(t.exportSuccess);
        } catch (err) {
            showToast("Ë§áË£ΩÂ§±ÊïóÔºåË´ãÈáçË©¶");
        }
        document.body.removeChild(textArea);
      };

      if (isLoading) return <div className="min-h-screen flex items-center justify-center bg-neutral-50 text-neutral-400">Loading...</div>;

      return (
        <div className="min-h-screen bg-neutral-50 pb-28 font-sans text-neutral-800 flex flex-col items-center">
          
          {/* Toast ÊèêÁ§∫Ê°Ü */}
          {toastMsg && (
            <div className="fixed top-10 left-1/2 transform -translate-x-1/2 z-50 animate-in fade-in slide-in-from-top-5">
              <div className="bg-neutral-800 text-white text-sm px-5 py-3 rounded-full shadow-xl font-medium flex items-center gap-2 whitespace-nowrap">
                {toastMsg}
              </div>
            </div>
          )}

          <header className="w-full max-w-md bg-white px-6 py-5 shadow-sm sticky top-0 z-40 flex justify-between items-center rounded-b-xl">
            <h1 className="text-xl font-bold text-neutral-800 tracking-wide">
              {config.nickname ? `${config.nickname} ÁöÑ${t.appTitle}` : t.appTitle}
            </h1>
            {activeTab === 'analysis' && <span className="text-sm font-medium text-neutral-400">{t.analysisTitle}</span>}
          </header>

          <main className="w-full max-w-md p-5 flex-1">
            
            {/* ================= HOME TAB ================= */}
            {activeTab === 'home' && (
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl p-5 text-white shadow-md">
                    <p className="text-xs text-indigo-100 mb-1">{t.cumulativeSurplus}</p>
                    <p className="text-2xl font-bold">${cumulativeSurplus.toFixed(1)}</p>
                    <p className="text-[10px] text-indigo-200 mt-2">‰æùË®≠ÂÆöËµ∑ÂßãÊó•Ë®àÁÆó</p>
                  </div>
                  <div className="bg-white rounded-3xl p-5 shadow-sm border border-neutral-100 flex flex-col justify-center">
                    <p className="text-xs text-neutral-400 mb-1">{t.todayRemaining}</p>
                    <p className={`text-2xl font-bold ${todayRemaining < 0 ? 'text-red-500' : 'text-neutral-800'}`}>
                      ${todayRemaining}
                    </p>
                    <p className="text-[10px] text-neutral-400 mt-2">{t.dailyBudget}: ${config.dailyLimit}</p>
                  </div>
                </div>

                <div className="bg-white rounded-3xl p-5 shadow-sm border border-neutral-100">
                  <h2 className="text-sm font-bold text-neutral-700 mb-3">{t.aiEntryTitle}</h2>
                  <div className="flex gap-2">
                    <input type="text" 
                      className="flex-1 bg-neutral-50 border-none rounded-2xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-purple-200 transition-all" 
                      placeholder={t.aiPlaceholder}
                      value={aiText} onChange={e => setAiText(e.target.value)}
                      onKeyDown={e => e.key === 'Enter' && handleAIEntry()}
                    />
                    <button 
                      onClick={handleAIEntry} disabled={isAiProcessing || !aiText.trim()}
                      className={`px-4 py-2 rounded-2xl font-bold text-sm transition-all ${isAiProcessing ? 'bg-neutral-200 text-neutral-400' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}`}
                    >
                      {isAiProcessing ? '...' : t.aiBtn}
                    </button>
                  </div>
                </div>

                <div className="bg-white rounded-3xl p-5 shadow-sm border border-neutral-100">
                  <h2 className="text-sm font-bold text-neutral-700 mb-4">{t.manualEntryTitle}</h2>
                  <form onSubmit={handleAddExpense} className="space-y-4">
                    <div className="flex gap-3">
                      <div className="flex-1">
                        <label className="block text-[10px] text-neutral-400 mb-1 ml-1">{t.itemName}</label>
                        <input type="text" required
                          className="w-full bg-neutral-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-100 text-sm font-medium" 
                          placeholder={t.itemName}
                          value={newExpense.item} onChange={e => setNewExpense({...newExpense, item: e.target.value})} 
                        />
                      </div>
                      <div className="w-[100px]">
                        <label className="block text-[10px] text-neutral-400 mb-1 ml-1">{t.amount}</label>
                        <input type="number" required
                          className="w-full bg-neutral-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-100 text-sm font-bold text-indigo-700" 
                          placeholder="0"
                          value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} 
                        />
                      </div>
                    </div>
                    
                    <div className="flex gap-3">
                      <div className="w-2/5">
                        <label className="block text-[10px] text-neutral-400 mb-1 ml-1">{t.category}</label>
                        <select 
                          className="w-full bg-neutral-50 rounded-xl px-3 py-3 outline-none focus:ring-2 focus:ring-indigo-100 text-sm text-neutral-700"
                          value={newExpense.category} onChange={e => setNewExpense({...newExpense, category: e.target.value})}
                        >
                          {t.categories.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                      </div>
                      <div className="flex-1">
                        <label className="block text-[10px] text-neutral-400 mb-1 ml-1">{t.note}</label>
                        <input type="text" 
                          className="w-full bg-neutral-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-100 text-sm" 
                          placeholder={t.note}
                          value={newExpense.note} onChange={e => setNewExpense({...newExpense, note: e.target.value})} 
                        />
                      </div>
                    </div>
                    
                    <button type="submit" className="w-full bg-neutral-800 text-white rounded-xl py-3.5 font-bold text-sm hover:bg-neutral-700 active:scale-[0.98] transition-all shadow-sm">
                      {t.saveBtn}
                    </button>
                  </form>
                </div>

                {todayExpenses.length > 0 && (
                  <div>
                    <h2 className="text-sm font-bold text-neutral-500 mb-3 px-1">{t.todayDetails} (Â∑≤Ëä±: ${todayTotal})</h2>
                    <div className="space-y-3">
                      {todayExpenses.map(expense => (
                        <div key={expense.id} className="bg-white p-4 rounded-2xl flex items-center justify-between shadow-sm border border-neutral-100">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center text-xs font-bold shrink-0">
                              {expense.category[0]}
                            </div>
                            <div className="min-w-0">
                              <p className="font-bold text-neutral-700 text-sm truncate">{expense.item}</p>
                              <div className="flex items-center gap-2 mt-0.5">
                                <span className="text-[10px] bg-neutral-100 text-neutral-500 px-1.5 py-0.5 rounded">{expense.category}</span>
                                {expense.note && <span className="text-[10px] text-neutral-400 truncate max-w-[100px]">{expense.note}</span>}
                              </div>
                            </div>
                          </div>
                          <div className="flex items-center gap-3 ml-2 shrink-0">
                            <span className="font-bold text-neutral-800">-${expense.amount}</span>
                            <button onClick={() => handleDeleteExpense(expense.id)} className="text-neutral-300 hover:text-red-400 transition-colors p-1">
                              <TrashIcon />
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* ================= WISHLIST TAB ================= */}
            {activeTab === 'wishlist' && (
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                <form onSubmit={handleAddWish} className="bg-white rounded-3xl p-5 shadow-sm border border-neutral-100 mb-6 space-y-4">
                  <div>
                    <input type="text" required
                      className="w-full bg-neutral-50 rounded-2xl px-4 py-3 outline-none focus:ring-2 focus:ring-pink-200 transition-all text-sm mb-3 font-bold" 
                      placeholder={t.wishDesc}
                      value={newWish.title} onChange={e => setNewWish({...newWish, title: e.target.value})} 
                    />
                    <textarea 
                      className="w-full bg-neutral-50 rounded-2xl px-4 py-3 outline-none focus:ring-2 focus:ring-pink-200 transition-all text-xs mb-3 resize-none h-20" 
                      placeholder={t.wishDescriptionPlaceholder}
                      value={newWish.description} onChange={e => setNewWish({...newWish, description: e.target.value})} 
                    ></textarea>
                    <input type="number" required
                      className="w-full bg-neutral-50 rounded-2xl px-4 py-3 outline-none focus:ring-2 focus:ring-pink-200 transition-all text-sm mb-4" 
                      placeholder={t.wishPrice}
                      value={newWish.price} onChange={e => setNewWish({...newWish, price: e.target.value})} 
                    />
                    
                    <p className="text-xs text-neutral-500 mb-2 ml-1">{t.wishMeaning}</p>
                    <div className="space-y-2 mb-4">
                      {t.wishTiers.map(tier => (
                        <label key={tier.level} 
                          className={`flex flex-col p-3 rounded-2xl border cursor-pointer transition-all ${
                            newWish.level === tier.level ? 'border-pink-300 bg-pink-50' : 'border-neutral-100 bg-white hover:bg-neutral-50'
                          }`}
                          onClick={() => setNewWish({...newWish, level: tier.level})}
                        >
                          <div className="flex items-center justify-between">
                            <span className="font-medium text-sm text-neutral-700">{tier.label}</span>
                            <div className={`w-4 h-4 rounded-full border-2 flex items-center justify-center ${newWish.level === tier.level ? 'border-pink-400' : 'border-neutral-300'}`}>
                              {newWish.level === tier.level && <div className="w-2 h-2 rounded-full bg-pink-400"></div>}
                            </div>
                          </div>
                          <span className="text-[10px] text-neutral-400 mt-1">{tier.desc}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                  <button type="submit" className="w-full bg-pink-500 text-white rounded-2xl py-3.5 font-bold text-sm hover:bg-pink-600 active:scale-[0.98] transition-all shadow-sm">
                    {t.wishBtn}
                  </button>
                </form>

                <div className="mb-4">
                  <p className="text-xs text-neutral-400 mb-2 ml-1">{t.wishShowTier}</p>
                  <div className="flex flex-wrap gap-2">
                    {t.wishTiers.map(tier => {
                      const isActive = activeTierFilters.includes(tier.level);
                      return (
                        <button key={tier.level}
                          onClick={() => {
                            if (isActive) setActiveTierFilters(prev => prev.filter(l => l !== tier.level));
                            else setActiveTierFilters(prev => [...prev, tier.level]);
                          }}
                          className={`px-3 py-1.5 rounded-full text-[10px] font-medium transition-all border ${
                            isActive ? 'bg-neutral-700 text-white border-neutral-700' : 'bg-white text-neutral-400 border-neutral-200'
                          }`}
                        >
                          {isActive ? '‚úì ' : ''}{tier.label}
                        </button>
                      );
                    })}
                  </div>
                </div>

                <div className="space-y-4">
                  {filteredWishlist.length === 0 ? (
                    <div className="text-center py-10 text-neutral-400 text-sm bg-white rounded-3xl border border-neutral-100 border-dashed">
                      {t.wishEmpty}
                    </div>
                  ) : (
                    filteredWishlist.sort((a,b) => a.level - b.level).map(wish => {
                      const currentTier = t.wishTiers.find(tier => tier.level === wish.level) || t.wishTiers[1];
                      return (
                        <WishCard 
                          key={wish.id}
                          wish={wish}
                          currentTier={currentTier}
                          onToggle={handleToggleWish}
                          onDelete={handleDeleteWish}
                          onAddSubItem={handleAddSubItem}
                          onToggleSubItem={handleToggleSubItem}
                          onDeleteSubItem={handleDeleteSubItem}
                          t={t}
                        />
                      )
                    })
                  )}
                </div>
              </div>
            )}

            {/* ================= ANALYSIS TAB ================= */}
            {activeTab === 'analysis' && (
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6">
                
                <div className="flex gap-2 mb-2 overflow-x-auto pb-1 hide-scrollbar">
                  {['today', 'week', 'month', 'custom'].map(preset => {
                    const labels = { today: t.today, week: t.thisWeek, month: t.thisMonth, custom: t.customRange };
                    return (
                      <button key={preset} 
                        onClick={() => preset === 'custom' ? setAnalysisPreset('custom') : setPresetRange(preset)}
                        className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border ${
                          analysisPreset === preset ? 'bg-neutral-800 text-white border-neutral-800' : 'bg-white text-neutral-500 border-neutral-200 hover:bg-neutral-50'
                        }`}
                      >
                        {labels[preset]}
                      </button>
                    )
                  })}
                </div>

                {analysisPreset === 'custom' && (
                  <div className="bg-white rounded-2xl p-4 shadow-sm border border-neutral-100 flex items-center gap-2 animate-in fade-in">
                    <input type="date" value={analysisDateRange.start} onChange={(e) => setAnalysisDateRange(prev => ({...prev, start: e.target.value}))}
                      className="flex-1 bg-neutral-50 text-neutral-700 text-xs rounded-xl px-2 py-2 outline-none border border-neutral-200"
                    />
                    <span className="text-neutral-400 text-xs">{t.to}</span>
                    <input type="date" value={analysisDateRange.end} onChange={(e) => setAnalysisDateRange(prev => ({...prev, end: e.target.value}))}
                      className="flex-1 bg-neutral-50 text-neutral-700 text-xs rounded-xl px-2 py-2 outline-none border border-neutral-200"
                    />
                  </div>
                )}

                <div className="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-3xl p-6 text-white shadow-md relative overflow-hidden">
                  <div className="relative z-10">
                    <p className="text-emerald-100 text-sm font-medium mb-1">{t.totalSpentRange}</p>
                    <p className="text-4xl font-bold">${analysisData.totalSpent}</p>
                    <p className="text-xs text-emerald-100 mt-2 opacity-80">{analysisData.filtered.length} Á≠ÜÁ¥ÄÈåÑ</p>
                  </div>
                  <button 
                    onClick={exportToMarkdown}
                    className="absolute top-4 right-4 bg-white/20 hover:bg-white/30 p-2 rounded-xl backdrop-blur-sm transition-all flex items-center gap-2 text-xs font-bold"
                  >
                    <CopyIcon /> {t.exportBtn}
                  </button>
                </div>

                <div className="bg-white p-5 rounded-3xl shadow-sm border border-neutral-100">
                  <h3 className="text-sm font-bold text-neutral-700 mb-4 flex items-center gap-2">
                    <ChartIcon /> {t.chartCategory}
                  </h3>
                  {analysisData.categoryArray.length === 0 ? (
                    <p className="text-center text-xs text-neutral-400 py-4">ÁÑ°Ë≥áÊñô</p>
                  ) : (
                    <div className="space-y-3">
                      {analysisData.categoryArray.map(cat => (
                        <div key={cat.name}>
                          <div className="flex justify-between items-end mb-1">
                            <span className="text-xs font-bold text-neutral-700">{cat.name}</span>
                            <div className="text-right">
                              <span className="text-xs font-bold text-neutral-700">${cat.amount}</span>
                              <span className="text-[10px] text-neutral-400 ml-2">{cat.percentage}%</span>
                            </div>
                          </div>
                          <div className="w-full bg-neutral-100 rounded-full h-1.5 overflow-hidden">
                            <div className="bg-teal-400 h-1.5 rounded-full" style={{ width: `${cat.percentage}%` }}></div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="bg-white p-5 rounded-3xl shadow-sm border border-neutral-100">
                  <h3 className="text-sm font-bold text-neutral-700 mb-4 flex items-center gap-2">
                    <ChartIcon /> {t.chartTrend}
                  </h3>
                  {analysisData.dateArray.length === 0 ? (
                    <p className="text-center text-xs text-neutral-400 py-4">ÁÑ°Ë≥áÊñô</p>
                  ) : (
                    <div className="relative h-32 w-full mt-4 border-b border-l border-neutral-200">
                      <svg className="w-full h-full overflow-visible" preserveAspectRatio="none" viewBox="0 0 100 100">
                        <polyline
                          fill="none" stroke="#2dd4bf" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
                          points={generateLinePath()}
                        />
                        {analysisData.dateArray.map((d, i) => {
                          const x = (i / Math.max(1, analysisData.dateArray.length - 1)) * 100;
                          const y = 100 - ((d.amount / analysisData.maxDaily) * 100);
                          return <circle key={i} cx={x} cy={y} r="1.5" fill="#0f766e" />;
                        })}
                      </svg>
                      <div className="absolute top-0 -left-1 transform -translate-x-full text-[8px] text-neutral-400">${analysisData.maxDaily}</div>
                      <div className="absolute bottom-0 -left-1 transform -translate-x-full translate-y-1/2 text-[8px] text-neutral-400">$0</div>
                    </div>
                  )}
                </div>

              </div>
            )}

            {/* ================= SETTINGS TAB ================= */}
            {activeTab === 'settings' && (
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6">
                
                <div className="bg-white rounded-3xl p-5 shadow-sm border border-neutral-100 space-y-4">
                  <div>
                    <label className="block text-xs font-bold text-neutral-700 mb-1.5">{t.nickname}</label>
                    <input type="text" 
                      className="w-full bg-neutral-50 rounded-xl px-4 py-2.5 outline-none focus:ring-2 focus:ring-neutral-200 text-sm border border-transparent" 
                      value={config.nickname || ''} placeholder="Ë®≠ÂÆöÊÇ®ÁöÑÁ®±Âëº"
                      onChange={e => setConfig({...config, nickname: e.target.value})} 
                      onBlur={(e) => saveConfig({nickname: e.target.value})}
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-bold text-neutral-700 mb-1.5">{t.dailyBudget} ($)</label>
                    <input type="number" 
                      className="w-full bg-neutral-50 rounded-xl px-4 py-2.5 outline-none focus:ring-2 focus:ring-neutral-200 text-sm font-medium border border-transparent" 
                      value={config.dailyLimit} 
                      onChange={e => setConfig({...config, dailyLimit: Number(e.target.value)})} 
                      onBlur={(e) => saveConfig({dailyLimit: Number(e.target.value)})}
                    />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-[10px] text-neutral-500 mb-1">{t.baseDate}</label>
                      <input type="date" 
                        className="w-full bg-neutral-50 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-neutral-200 text-xs border border-transparent" 
                        value={config.baseDate} 
                        onChange={e => setConfig({...config, baseDate: e.target.value})} 
                        onBlur={(e) => saveConfig({baseDate: e.target.value})}
                      />
                    </div>
                    <div>
                      <label className="block text-[10px] text-neutral-500 mb-1">{t.baseBalance}</label>
                      <input type="number" 
                        className="w-full bg-neutral-50 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-neutral-200 text-xs border border-transparent" 
                        value={config.baseBalance} 
                        onChange={e => setConfig({...config, baseBalance: Number(e.target.value)})} 
                        onBlur={(e) => saveConfig({baseBalance: Number(e.target.value)})}
                      />
                    </div>
                  </div>
                  <div>
                    <label className="block text-xs font-bold text-neutral-700 mb-1.5">{t.language}</label>
                    <select 
                      className="w-full bg-neutral-50 rounded-xl px-4 py-2.5 outline-none focus:ring-2 focus:ring-neutral-200 text-sm"
                      value={config.language} 
                      onChange={(e) => saveConfig({language: e.target.value})}
                    >
                      <option value="zh">ÁπÅÈ´î‰∏≠Êñá</option>
                      <option value="en">English</option>
                    </select>
                  </div>
                </div>

                {/* Â∏≥Êà∂ÂçÄÂ°ä */}
                <div className="bg-neutral-100 rounded-3xl p-5 border border-neutral-200 flex flex-col gap-3 relative">
                  <div className="flex items-center gap-3 mb-2">
                    {user && !user.isAnonymous && user.photoURL ? 
                      <img src={user.photoURL} className="w-10 h-10 rounded-full shadow-sm" alt="user"/> : 
                      <div className="w-10 h-10 rounded-full bg-neutral-300 flex items-center justify-center text-white"><SettingsIcon /></div>
                    }
                    <div>
                      <p className="text-xs font-bold text-neutral-800">
                        {user && !user.isAnonymous ? user.displayName : t.anonymous}
                      </p>
                      <p className="text-[10px] text-neutral-500">
                        {user && !user.isAnonymous ? user.email : 'Êú™ÂÇô‰ªΩÂà∞Èõ≤Á´ØÔºåË≥áÊñôÂÉÖÂ≠òÊñºÊú¨Ê©ü'}
                      </p>
                    </div>
                  </div>
                  
                  {(!user || user.isAnonymous) ? (
                    <button onClick={handleGoogleLogin} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold text-xs rounded-xl shadow-sm transition-colors">
                      {t.loginGoogle}
                    </button>
                  ) : (
                    <button onClick={handleLogout} className="w-full py-3 bg-white hover:bg-rose-50 text-rose-500 border border-rose-100 font-bold text-xs rounded-xl shadow-sm transition-colors">
                      {t.logout}
                    </button>
                  )}
                </div>
              </div>
            )}

          </main>

          <nav className="fixed bottom-0 w-full max-w-md bg-white border-t border-neutral-100 px-6 py-3 flex justify-between items-center z-50 rounded-t-2xl shadow-[0_-4px_20px_rgba(0,0,0,0.03)]">
            {[
              { id: 'home', icon: <HomeIcon />, label: t.navHome, color: 'text-indigo-600', bg: 'bg-indigo-50' },
              { id: 'wishlist', icon: <StarIcon />, label: t.navWish, color: 'text-pink-600', bg: 'bg-pink-50' },
              { id: 'analysis', icon: <ChartIcon />, label: t.navAnalysis, color: 'text-teal-600', bg: 'bg-teal-50' },
              { id: 'settings', icon: <SettingsIcon />, label: t.navSettings, color: 'text-neutral-800', bg: 'bg-neutral-100' }
            ].map(tab => (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                className={`flex flex-col items-center gap-1 p-2 rounded-2xl transition-all duration-300 ${activeTab === tab.id ? `${tab.bg} ${tab.color} scale-110 shadow-sm` : 'text-neutral-400 hover:bg-neutral-50'}`}
              >
                {tab.icon}
                <span className={`text-[10px] font-medium ${activeTab === tab.id ? 'opacity-100' : 'opacity-0 h-0 overflow-hidden'}`}>{tab.label}</span>
              </button>
            ))}
          </nav>

        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
